name: Cleanup GitHub Actions Storage

on:
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  cleanup-workflows:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # Required to delete workflow runs
    
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
              status: 'completed'
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            
            for (const run of runs.data.workflow_runs) {
              const runDate = new Date(run.created_at);
              
              // Skip runs that are less than 30 days old
              if (runDate > thirtyDaysAgo) continue;
              
              // Skip runs from main branch (keep for reference)
              if (run.head_branch === 'main') continue;
              
              // Delete the run
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
              
              deletedCount++;
              console.log(`Deleted workflow run #${run.id} from ${run.head_branch}`);
            }
            
            console.log(`Total workflow runs deleted: ${deletedCount}`);
            
  cleanup-artifacts:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # Required to delete artifacts
      
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              const createdDate = new Date(artifact.created_at);
              
              // Delete artifacts older than 7 days
              if (createdDate < sevenDaysAgo) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                
                deletedCount++;
                console.log(`Deleted artifact: ${artifact.name} (${artifact.size_in_bytes} bytes)`);
              }
            }
            
            console.log(`Total artifacts deleted: ${deletedCount}`);
            
      - name: Report storage savings
        run: |
          echo "## ðŸ§¹ Storage Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleanup completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions taken:" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted workflow runs older than 30 days (except main branch)" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted artifacts older than 7 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor storage usage regularly" >> $GITHUB_STEP_SUMMARY
          echo "- Consider reducing artifact retention periods further if needed" >> $GITHUB_STEP_SUMMARY
          echo "- Use caching instead of artifacts where possible" >> $GITHUB_STEP_SUMMARY